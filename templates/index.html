<!doctype html>
<html lang="en">
  <head>
    <title>Hybrid Movie Recommender</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <style>
      body {
        background-color: #ffffff;
        color: #1e293b;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      .navbar {
        background-color: #1e293b !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .card {
        background-color: #ffffff;
        border-radius: 0.85rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .card img {
        border-radius: 0.6rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 0.75rem;
      }

      .badge-genre {
        background-color: #3b82f6;
        color: white;
        margin-right: 0.25rem;
        padding: 0.35em 0.55em;
        border-radius: 0.35rem;
        font-size: 0.75rem;
      }

      .score-text {
        font-size: 0.9rem;
        color: #475569;
      }

      .form-control,
      .form-select {
        background-color: #ffffff;
        color: #1e293b;
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
      }

      .btn-primary {
        background-color: #2563eb;
        border-color: #1d4ed8;
        border-radius: 0.5rem;
        padding: 0.6rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      }

      .btn-primary:hover {
        background-color: #1d4ed8;
      }

      .btn-outline-primary {
        border-radius: 999px;
        font-size: 0.8rem;
        padding: 0.25rem 0.55rem;
      }
    </style>

  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
          üé¨ Hybrid Movie Recommender
        </span>
      </div>
    </nav>

    <div class="container-fluid mt-3">
      <div class="row">

        <!-- LEFT PANEL -->
        <div class="col-md-3 mb-4">
          <div class="card p-3">
            <div class="section-title">User and preferences</div>

            <!-- Static user description -->
            <div class="mb-3">
              <label class="form-label">User</label>
              <p class="score-text mb-0">This device</p>
            </div>

            <form method="post">

              <div class="mb-3">
                <label class="form-label">Genres</label>
                <div class="form-check">
                  {% for g in ["Action","Comedy","Drama","Horror","Romance","Sci fi","Animation"] %}
                    <div>
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="genres"
                        id="g-{{ g }}"
                        value="{{ g }}"
                        {% if g in default_genres %}checked{% endif %}
                      >
                      <label class="form-check-label" for="g-{{ g }}">{{ g }}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">How new</label>
                <select class="form-select" name="year_choice">
                  <option value="after2000" {% if default_year_choice == "after2000" %}selected{% endif %}>After 2000</option>
                  <option value="after1980" {% if default_year_choice == "after1980" %}selected{% endif %}>After 1980</option>
                  <option value="any" {% if default_year_choice == "any" %}selected{% endif %}>Any year</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Popularity</label>
                <select class="form-select" name="pop_choice">
                  <option value="popular" {% if default_pop_choice == "popular" %}selected{% endif %}>Big hits</option>
                  <option value="mixed" {% if default_pop_choice == "mixed" %}selected{% endif %}>Mix of both</option>
                  <option value="hidden" {% if default_pop_choice == "hidden" %}selected{% endif %}>Hidden gems</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Foreign films</label>
                <select name="foreign_choice" class="form-select">
                  <option value="any"   {% if default_foreign_choice == 'any' %}selected{% endif %}>Include all</option>
                  <option value="exclude" {% if default_foreign_choice == 'exclude' %}selected{% endif %}>Exclude foreign films</option>
                  <option value="only" {% if default_foreign_choice == 'only' %}selected{% endif %}>Only foreign films</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Preference weight (alpha)</label>
                <input
                  type="range"
                  class="form-range"
                  name="alpha"
                  min="0"
                  max="1"
                  step="0.05"
                  value="{{ default_alpha }}"
                >
                <div class="score-text">
                  0 = history only, 1 = preferences only
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100">
                Recommend
              </button>
            </form>

          </div>

          {% if error %}
            <div class="alert alert-danger mt-3">
              {{ error }}
            </div>
          {% endif %}
        </div>

        <!-- RIGHT PANEL: RESULTS -->
        <div class="col-md-9">
          <div class="section-title">Recommendations</div>

          {% if results %}
            <div class="row g-3">
              {% for r in results %}
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 p-2 movie-card" data-movie-id="{{ r.movie_id }}">

                    {% if r.poster_url %}
                      <img src="{{ r.poster_url }}" class="card-img-top" alt="Poster">
                    {% endif %}

                    <div class="card-body">
                      <h5 class="card-title">{{ r.title }}</h5>
                      {% if r.year %}
                        <p class="card-subtitle mb-1 text-muted">{{ r.year }}</p>
                      {% endif %}

                      <div class="mb-2">
                        {% for g in r.genres.split("|") %}
                          <span class="badge-genre">{{ g }}</span>
                        {% endfor %}
                      </div>

                      <p class="score-text mb-1">
                        Average rating: {{ "%.2f"|format(r.avg_rating) }}
                        from {{ r.num_ratings }} ratings
                      </p>
                      <p class="score-text mb-1">
                        History score: {{ "%.2f"|format(r.history_score) }}
                      </p>
                      <p class="score-text mb-2">
                        Preference score: {{ "%.2f"|format(r.pref_score) }},
                        final: {{ "%.3f"|format(r.final_score) }}
                      </p>

                      <!-- Rating buttons with AJAX -->
                      <div class="mt-2">
                        <div class="score-text mb-1">Rate this movie:</div>
                        <div class="btn-group" role="group" aria-label="Rate movie">
                          <button type="button"
                                  class="btn btn-sm btn-outline-primary rate-btn"
                                  data-movie="{{ r.movie_id }}"
                                  data-rating="5">5‚≠ê</button>
                          <button type="button"
                                  class="btn btn-sm btn-outline-primary rate-btn"
                                  data-movie="{{ r.movie_id }}"
                                  data-rating="4">4‚≠ê</button>
                          <button type="button"
                                  class="btn btn-sm btn-outline-primary rate-btn"
                                  data-movie="{{ r.movie_id }}"
                                  data-rating="3">3‚≠ê</button>
                          <button type="button"
                                  class="btn btn-sm btn-outline-primary rate-btn"
                                  data-movie="{{ r.movie_id }}"
                                  data-rating="2">2‚≠ê</button>
                          <button type="button"
                                  class="btn btn-sm btn-outline-primary rate-btn"
                                  data-movie="{{ r.movie_id }}"
                                  data-rating="1">1‚≠ê</button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">
              Choose options on the left and click Recommend to see movies.
            </p>
          {% endif %}
        </div>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const buttons = document.querySelectorAll(".rate-btn");

        buttons.forEach((btn) => {
          btn.addEventListener("click", async () => {
            const movieId = btn.dataset.movie;
            const rating = btn.dataset.rating;

            const formData = new FormData();
            formData.append("movie_id", movieId);
            formData.append("rating", rating);

            try {
              const resp = await fetch("/rate", {
                method: "POST",
                headers: {
                  "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
              });

              const data = await resp.json();

              if (data.ok) {
                const card = btn.closest(".movie-card");
                if (card) {
                  card.style.opacity = "0";
                  card.style.transform = "translateY(4px)";
                  setTimeout(() => {
                    card.remove();
                  }, 300);
                }
              } else {
                alert("Error saving rating: " + (data.error || "Unknown error"));
              }
            } catch (err) {
              alert("Network error while saving rating");
              console.error(err);
            }
          });
        });
      });
    </script>
  </body>
</html>
